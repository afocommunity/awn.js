<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Models/HTTP_CLIENT/index.js - Documentation</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://awn.gg/" target="_blank" class="menu-item" id="website_link" >AWN Portal</a></h2><h2><a href="https://github.com/werewolfboy13/awn.js" target="_blank" class="menu-item" id="website_link" >Github</a></h2><h2><a href="https://github.com/werewolfboy13/awn.js/discussions" target="_blank" class="menu-item" id="forum_link" >Discussions</a></h2><h2><a href="https://discord.gg/6y2A4Pk" target="_blank" class="menu-item" id="discord_link" >Discord</a></h2><h3>Classes</h3><ul><li><a href="AdminList.html">AdminList</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdminList.html#AddAdmin">AddAdmin</a></li><li data-type='method' style='display: none;'><a href="AdminList.html#Fetch">Fetch</a></li><li data-type='method' style='display: none;'><a href="AdminList.html#RemoveAdmin">RemoveAdmin</a></li></ul></li><li><a href="AWN.html">AWN</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AWN.html#Error">Error</a></li><li data-type='method' style='display: none;'><a href="AWN.html#FetchOrg">FetchOrg</a></li><li data-type='method' style='display: none;'><a href="AWN.html#FetchUser">FetchUser</a></li><li data-type='method' style='display: none;'><a href="AWN.html#Login">Login</a></li></ul></li><li><a href="CancellationTokenSource.html">CancellationTokenSource</a></li><li><a href="CloudResult.html">CloudResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CloudResult.html#CloudResult">CloudResult</a></li></ul></li><li><a href="DedicatedBox.html">DedicatedBox</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DedicatedBox.html#FetchInstances">FetchInstances</a></li></ul></li><li><a href="Dictionary.html">Dictionary</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Dictionary.html#.ToDictionary">ToDictionary</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#Add">Add</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#AddOrUpdate">AddOrUpdate</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#Clear">Clear</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#ContainsKey">ContainsKey</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#ContainsValue">ContainsValue</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#EnsureCapacity">EnsureCapacity</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#Get">Get</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#Reduce">Reduce</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#Remove">Remove</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#RemoveAt">RemoveAt</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#Replace">Replace</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#TryAdd">TryAdd</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#TryGetValue">TryGetValue</a></li><li data-type='method' style='display: none;'><a href="Dictionary.html#TryRemove">TryRemove</a></li></ul></li><li><a href="Enumerable.html">Enumerable</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Enumerable.html#FromNumber">FromNumber</a></li><li data-type='method' style='display: none;'><a href="Enumerable.html#GetValue">GetValue</a></li></ul></li><li><a href="Enumerator.html">Enumerator</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Enumerator.html#MoveNext">MoveNext</a></li></ul></li><li><a href="Game.html">Game</a></li><li><a href="Http.html">Http</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Http.html#AddBody">AddBody</a></li><li data-type='method' style='display: none;'><a href="Http.html#CreateRequest">CreateRequest</a></li><li data-type='method' style='display: none;'><a href="Http.html#DELETE">DELETE</a></li><li data-type='method' style='display: none;'><a href="Http.html#GET">GET</a></li><li data-type='method' style='display: none;'><a href="Http.html#PATCH">PATCH</a></li><li data-type='method' style='display: none;'><a href="Http.html#POST">POST</a></li><li data-type='method' style='display: none;'><a href="Http.html#PUT">PUT</a></li><li data-type='method' style='display: none;'><a href="Http.html#RunRequest">RunRequest</a></li></ul></li><li><a href="HTTP_CLIENT.html">HTTP_CLIENT</a><ul class='methods'><li data-type='method' style='display: none;'><a href="HTTP_CLIENT.html#SendAsync">SendAsync</a></li></ul></li><li><a href="HttpRequestMessage.html">HttpRequestMessage</a></li><li><a href="HttpResponseMessage.html">HttpResponseMessage</a></li><li><a href="Instance.html">Instance</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Instance.html#Fetch">Fetch</a></li><li data-type='method' style='display: none;'><a href="Instance.html#SetProperties">SetProperties</a></li></ul></li><li><a href="List.html">List</a><ul class='methods'><li data-type='method' style='display: none;'><a href="List.html#.ToList">ToList</a></li><li data-type='method' style='display: none;'><a href="List.html#Add">Add</a></li><li data-type='method' style='display: none;'><a href="List.html#AddRange">AddRange</a></li><li data-type='method' style='display: none;'><a href="List.html#Any">Any</a></li><li data-type='method' style='display: none;'><a href="List.html#Clear">Clear</a></li><li data-type='method' style='display: none;'><a href="List.html#Contains">Contains</a></li><li data-type='method' style='display: none;'><a href="List.html#Exists">Exists</a></li><li data-type='method' style='display: none;'><a href="List.html#Find">Find</a></li><li data-type='method' style='display: none;'><a href="List.html#ForEach">ForEach</a></li><li data-type='method' style='display: none;'><a href="List.html#Remove">Remove</a></li><li data-type='method' style='display: none;'><a href="List.html#RemoveAt">RemoveAt</a></li><li data-type='method' style='display: none;'><a href="List.html#Sort">Sort</a></li><li data-type='method' style='display: none;'><a href="List.html#TakeRandom">TakeRandom</a></li><li data-type='method' style='display: none;'><a href="List.html#ToArray">ToArray</a></li><li data-type='method' style='display: none;'><a href="List.html#TryGetValue">TryGetValue</a></li></ul></li><li><a href="Organization.html">Organization</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Organization.html#Fetch">Fetch</a></li><li data-type='method' style='display: none;'><a href="Organization.html#FetchAdminLists">FetchAdminLists</a></li><li data-type='method' style='display: none;'><a href="Organization.html#FetchBoxes">FetchBoxes</a></li><li data-type='method' style='display: none;'><a href="Organization.html#FetchInstances">FetchInstances</a></li><li data-type='method' style='display: none;'><a href="Organization.html#FetchUsers">FetchUsers</a></li></ul></li><li><a href="Out.html">Out</a></li><li><a href="Role.html">Role</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Role.html#Fetch">Fetch</a></li></ul></li><li><a href="TimeSpan.html">TimeSpan</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TimeSpan.html#.Delay">Delay</a></li></ul></li><li><a href="User.html">User</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-overview.html">Overview</a></li></ul><h3>Global</h3><ul><li><a href="global.html#HttpMethod">HttpMethod</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Models/HTTP_CLIENT/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { HttpMethod } = require("./HttpMethod");
const { HttpRequestMessage } = require("./HttpRequestMessage");
const { CancellationTokenSource } = require("./CancellationTokenSource");
const { TimeSpan } = require("../Util/TimeSpan");
const { CloudResult } = require("./CloudResult");
const { ProductInfoHeaderValue } = require("./ProductInfoHeaderValue");
const { HTTP_CLIENT } = require("./HTTP_CLIENT");
/**
 * HTTP Client
 * @class Http
 */
class Http {
	constructor(Bot) {
		this.Bot = Bot;
		this.ENDPOINT = "https://api.awn.gg/v5";
		this.DefaultTimeout = TimeSpan.fromSeconds(6);
		this.UserAgent = new ProductInfoHeaderValue(
			"AWN.js",
			require("../../../package.json").version
		);
		this.DEBUG_REQUESTS = false;
		this._currentAuthenticationToken = null;
		this.HttpClient = new HTTP_CLIENT();
	}
	OnError(...err) {
		throw Error(err);
	}
	OnDebug(...info) {
		console.log(...info);
	}
	/**
	 * Make a Get Request
	 *
	 * @param {string} resource - Endpoint
	 * @param {TimeSpan} [timeout=null]
	 * @param {boolean} [throwOnError=true]
	 * @returns {Promise&lt;CloudResult&lt;any>>}
	 * @memberof Http
	 */
	GET(resource, timeout = null, throwOnError = true) {
		return this.RunRequest(
			() => {
				return this.CreateRequest(resource, HttpMethod.Get);
			},
			timeout,
			throwOnError
		);
	}
	/**
	 * Make a Post Request
	 *
	 * @param {string} resource - Endpoint
	 * @param {*} entity - Content
	 * @param {TimeSpan} [timeout=null]
	 * @param {boolean} [throwOnError=true]
	 * @returns {Promise&lt;CloudResult&lt;any>>}
	 * @memberof Http
	 */
	POST(resource, entity, timeout = null, throwOnError = true) {
		return this.RunRequest(
			() => {
				let request = this.CreateRequest(resource, HttpMethod.Post);
				if (entity != null) this.AddBody(request, entity);
				return request;
			},
			timeout,
			throwOnError
		);
	}
	/* //TODO
	POST_File(resource, filePath, FileMIME = null, progressIndicator = null) {
		return this.RunRequest(() => {
			let request = this.CreateRequest(resource, HttpMethod.Post);
			//TODO this.AddFileToRequest(request, filePath, FileMIME, progressIndicator);
			return request;
		}, TimeSpan.fromMinutes(60.0));
	}
	*/
	/**
	 * Make a Put Request
	 *
	 * @param {string} resource - Endpoint
	 * @param {*} entity - Content
	 * @param {TimeSpan} [timeout=null]
	 * @param {boolean} [throwOnError=true]
	 * @returns {Promise&lt;CloudResult&lt;any>>}
	 * @memberof Http
	 */
	PUT(resource, entity, timeout = null, throwOnError = true) {
		return this.RunRequest(
			() => {
				let request = this.CreateRequest(resource, HttpMethod.Put);
				this.AddBody(request, entity);
				return request;
			},
			timeout,
			throwOnError
		);
	}
	/**
	 * Make a Patch Request
	 *
	 * @param {string} resource - Endpoint
	 * @param {*} entity - Content
	 * @param {TimeSpan} [timeout=null]
	 * @param {boolean} [throwOnError=true]
	 * @returns {Promise&lt;CloudResult&lt;any>>}
	 * @memberof Http
	 */
	PATCH(resource, entity, timeout = null, throwOnError = true) {
		return this.RunRequest(
			() => {
				let request = this.CreateRequest(resource, HttpMethod.Patch);
				this.AddBody(request, entity);
				return request;
			},
			timeout,
			throwOnError
		);
	}
	/**
	 * Make a Delete Request
	 *
	 * @param {string} resource - Endpoint
	 * @param {TimeSpan} [timeout=null]
	 * @param {boolean} [throwOnError=true]
	 * @returns {Promise&lt;CloudResult&lt;any>>}
	 * @memberof Http
	 */
	DELETE(resource, timeout = null, throwOnError = true) {
		return this.RunRequest(
			() => {
				return this.CreateRequest(resource, HttpMethod.Delete);
			},
			timeout,
			throwOnError
		);
	}
	/**
	 * Build a Http Request
	 *
	 * @param {string} resource - Endpoint
	 * @param {HttpMethod} method
	 * @instance
	 * @returns {HttpRequestMessage}
	 * @memberof Http
	 */
	CreateRequest(resource, method) {
		var flag = false;
		if (!resource.startsWith("http")) {
			flag = true;
			resource = this.ENDPOINT + "/" + resource;
		}
		var httpRequestMessage = new HttpRequestMessage(method, resource);
		if ((this._currentAuthenticationToken != null) &amp; flag) {
			httpRequestMessage.Headers[
				"X-AWN-ACCESS-TOKEN"
			] = this._currentAuthenticationToken;
		}
		httpRequestMessage.Headers.UserAgent = this.UserAgent.Value();
		return httpRequestMessage;
	}
	/**
	 * Add a body to a request
	 *
	 * Internal
	 * @param {HttpRequestMessage} message
	 * @instance
	 * @param {*} entity - Content
	 * @memberof Http
	 */
	AddBody(message, entity) {
		message.Headers["Content-Type"] = "application/json";
		if (entity) message.Content = JSON.stringify(entity);
	}

	/**
	 * Run a {@link #httprequestmessage HttpRequest}
	 * @see Http#CreateRequest
	 * @param {HttpRequestMessage} requestSource
	 * @param {TimeSpan} timeout
	 * @param {boolean} [throwOnError=false]
	 * @returns {Promise&lt;CloudResult&lt;any>>}
	 * @memberof Http
	 * @instance
	 */
	async RunRequest(requestSource, timeout, throwOnError = false) {
		let request = null;
		let result = null;
		let exception = null;
		let content;
		let result1;
		try {
			let remainingRetries = this.DEFAULT_RETRIES; //lgtm [js/useless-assignment-to-local] False Positive
			let delay = 250;
			do {
				try {
					request = await requestSource();
					let cancellationTokenSource = new CancellationTokenSource(
						timeout || this.DefaultTimeout
					);
					if (this.DEBUG_REQUESTS)
						this.OnDebug(request.Method, request.RequestUri);
					result = await this.HttpClient.SendAsync(
						request,
						cancellationTokenSource.Token
					);
					if (this.DEBUG_REQUESTS)
						this.OnDebug(request.Method, request.RequestUri, result.StatusCode);
				} catch (error2) {
					exception = error2;
				}
				// Handle Error Response, Will Retry after &lt;delay>
				if (
					result == null ||
					result.StatusCode === 429 ||
					result.StatusCode === 500
				) {
					if (result == null) {
						this.OnDebug(
							`Exception running ${request.Method} request to ${request.RequestUri}. Remaining retries: ${remainingRetries}`
						);
						await TimeSpan.Delay(new TimeSpan(delay)); // Wait and then retry
						delay *= 2; // Double Retry Time
					}
				}
			} while (result == null &amp;&amp; remainingRetries-- > 0);
			if (result == null) {
				if (!throwOnError) {
					result1 = new CloudResult(null, 0, null, null);
				} else {
					if (exception == null)
						this.OnError("Failed to get response. Exception is null");
					this.OnError(exception);
				}
			} else {
				if (result.IsSuccessStatusCode) {
					if (typeof result.Content === "string") {
						content = result.Content;
					} else {
						content = result.Content;
						if (this.DEBUG_REQUESTS)
							this.OnDebug(
								`ENTITY for ${request.Method} - ${request.RequestUri}`
							);
					}
					result1 = new CloudResult(null, result.StatusCode, content);
				} else {
					// Bad Status Code
					result1 = new CloudResult(null, result.StatusCode, result.Content);
				}
			}
		} catch (ex) {
			this.OnError(ex, true); // This is a Hard Error, Request has Failed Spectacularly for some reason and will return No value, Likely braking what called it, Suggest Throw
		}
		return result1;
	}
}
module.exports = { Http };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Tue Mar 09 2021 17:12:37 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
